# Distributed under the Boost Software License, Version 1.0.
# See accompanying file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt

import shader : program ;
import multiarch ;
import path ;

lib GL : : [ multiarch.search-path ] <name>:libGL.so.1 ;
lib GLU : : [ multiarch.search-path ] ;
lib glfw : : [ multiarch.search-path ] ;
lib boost_thread : : [ multiarch.search-path ] ;
lib boost_program_options : : [ multiarch.search-path ] ;
lib boost_filesystem : : [ multiarch.search-path ] ;
lib boost_regex : : [ multiarch.search-path ] ;
lib boost_iostreams : : [ multiarch.search-path ] ;
lib boost_date_time : : [ multiarch.search-path ] ;
lib boost_system : : [ multiarch.search-path ] ;
lib boost_log : : [ multiarch.search-path ] ;
lib logging : : [ multiarch.search-path ] ;
lib glut : : [ multiarch.search-path ] ;
lib X11 : : [ multiarch.search-path ] ;

project libgtulu : requirements
  <library>GL/<link>shared
  <library>GLU
  <library>X11
  <library>glfw
  <library>boost_thread
  <library>boost_program_options
  <library>boost_filesystem
  <library>boost_regex
  <library>boost_iostreams
  <library>boost_date_time
  <library>boost_system
  <library>boost_log
  <library>logging
  <include>include/
  
  $(INCLUDES)
  <tag>@$(__name__).tag
  
  <threading>multi
  <variant>debug:<define>GTULU_DEBUG
  <variant>release:<define>NO_GTULU_DEBUG
  <cflags>-std=c++0x
  <cflags>-Wno-multichar
  : default-build debug ;


rule for-each ( rule : suffix ? : sources * : dependencies * : properties * ) {
  for local name in $(sources) {
    name_o = [ MATCH "^$(BUILD_ROOT)/(.+).cpp$" : $(name) ] ;
    if ! $(name_o) {
      name_o = [ MATCH "^$(BUILD_ROOT)/(.+)$" : $(name) ] ;
      name_o = $(name_o)$(suffix) ;
    }
    if ! $(name_o) {
      name_o = [ MATCH "^(.+)$" : $(name) ] ;
      name_o = $(name_o)$(suffix) ;
    }
    objects += $(name_o) ;
    $(rule) $(name_o) : $(name) $(dependencies) : $(properties) ;
  }
  
  return $(objects) ;
}

cpp-pch gtulu_opengl_pch.hpp : include/gtulu_opengl_pch.hpp ;

obj common : src/common.cpp gtulu_opengl_pch.hpp ;

lib gtulu : 
  src/gtulu/utils/file.cpp
  src/gtulu/internal/constants.cpp
  src/gtulu/internal/texture_unit_manager.cpp
  src/gtulu/internal/formats/output.cpp
  src/gtulu/internal/formats/uniform.cpp
  src/gtulu/internal/formats/attribute.cpp
  src/gtulu/internal/objects/object.cpp
  src/gtulu/internal/formats/program/dynamic.cpp
  src/gtulu/internal/formats/shader/dynamic.cpp
  src/gtulu/internal/objects/framebuffer/attachment_manager.cpp
  src/gtulu/internal/objects/program/base.cpp
  src/gtulu/internal/objects/shader/base.cpp
  gtulu_opengl_pch.hpp
  ;
exe gtulu-compiler : src/compile.cpp common gtulu gtulu_opengl_pch.hpp ;

program test1 : test/shaders/test1.vs test/shaders/test1.fs : <location>test/generated/ ;
program test2 : test/shaders/test2.vs test/shaders/test2.fs : <location>test/generated/ ;
program test3 : test/shaders/test3.vs test/shaders/test3.fs : <location>test/generated/ ;

exe test1exe : test/test1.cpp test1 common gtulu gtulu_opengl_pch.hpp
    : <address-model>$(default_address_model) ;
exe test2exe : test/test2.cpp test2 common gtulu gtulu_opengl_pch.hpp
    : <address-model>$(default_address_model) ;
exe test3exe : test/test3.cpp test3 common gtulu gtulu_opengl_pch.hpp
    : <address-model>$(default_address_model) ;

alias test : test1exe/<link>shared
             test2exe/<link>shared
             test3exe/<link>shared
             test1exe/<link>static
             test2exe/<link>static
             test3exe/<link>static ;


multiarch.build build libgtulu
                : gtulu-compiler
                : gtulu
                : ;

multiarch.install install libgtulu 
                    : gtulu-compiler
                    : gtulu
                    : [ path.glob-tree include/ : *.* : ]
                    : <install-source-root>./include/ ;